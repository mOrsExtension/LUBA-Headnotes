<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<html lang="en">
 <head>
    <title>Display</title>
</head>

{% macro check_type(rows, sql_query) %}
    {% set first_row = rows[0] %}
    {% set has_standard_fields = 'headnote' in first_row.keys() and 'summary' in first_row.keys() %}
    {% set is_aggregate_sql = 'count(' in sql_query or 'group by' in sql_query or 'sum(' in sql_query or 'avg(' in sql_query %}
    {% set use_table_view = is_aggregate_sql or not has_standard_fields %}

    {% if use_table_view %}
        {{ render_count(rows)}}
    {% else %}
        <div class="results-info">
            Showing {{ rows|length }} result{% if rows|length != 1 %}s{% endif %}
            {% if filtered_table_rows_count and filtered_table_rows_count != table_rows_count %}
                (filtered from {{ table_rows_count }} total)
            {% endif %}
        </div>

        {% for row in rows %}
            {{ render_headnote(row, loop.index) }}
        {% endfor %}

    {% endif %}
{% endmacro %}

{% macro render_count(rows) %}
    {% set first_row = rows[0] %}
    <div class="aggregate-results">
        <h3>Query Results</h3>
        <table>
            <thead>
                <tr>
                    {% for key in first_row.keys() %}
                        <th>{{ key }}</th>
                    {% endfor %}
                 </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                    <tr>
                        {% for key in first_row.keys() %}
                            <td>{{ row[key] }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endmacro %}

{% macro render_headnote(row, loop_index) %}

<div class="headnote-entry">
<div class="headnote-header">
    <strong>Headnote:</strong> {{ row.headnote or row.headnote_number }}&nbsp;&nbsp;{{ row.topic }}
</div>

<div class="case-citation">
    {% if row.case_name %}
        {{ row.case_name }}{% if row.reporter and row.reporter != "" %}, {{ row.reporter }}{% endif %}{% if row.year %} ({{ row.year }}){% endif %}
    {% elif row.reporter %}
        [Name Missing]{{ row.reporter}}{% if row.year %} ({{ row.year }}){% endif %}
    {% elif row.year %}
        [Name and Reporter Missing] ({{ row.year }})
    {% else %}
        [Citation Incomplete]
    {% endif %}
</div>

<div class="summary">
    <strong>Summary:</strong>
    <span id="summary-{{ loop_index }}" class="formatted-text">{{ row.summary }}</span>
</div>

{% if row.pub_pdf_url and row.pub_pdf_url != "" %}
    <div class="opinion_link">
        <a href="{{ row.pub_pdf_url }}">Opinion PDF from oregon.gov/luba/Docs</a>
    </div>
{% endif %}

<div class="metadata"><details>
    <summary>metadata:</summary>
    {% if row.year %}
        <div class="metadata-line"><strong>Opinion Date:</strong> {% if row.pub_month %}{{ row.pub_month }}-{% endif %}{{ row.year }}</div>
    {% endif %}

    {% if row.luba_no and row.luba_no != "" %}
        <div class="metadata-line"><strong>LUBA No.:</strong> {{ row.luba_no }}</div>
    {% endif %}

    {% if row.case_cites and row.case_cites != "[]" and row.case_cites != "" %}
        <div class="metadata-line"><strong>Case Cites:</strong> {{ row.case_cites|replace('[', '')|replace(']', '')|replace('"', '') }}</div>
    {% endif %}

    {% if row.ors_cites and row.ors_cites != "[]" and row.ors_cites != "" %}
        <div class="metadata-line"><strong>ORS Cites:</strong> {{ row.ors_cites|replace('[', '')|replace(']', '')|replace('"', '') }}</div>
    {% endif %}

    {% if row.oar_cites and row.oar_cites != "[]" and row.oar_cites != "" %}
        <div class="metadata-line"><strong>OAR Cites:</strong> {{ row.oar_cites|replace('[', '')|replace(']', '')|replace('"', '') }}</div>
    {% endif %}

    {% if row.pub_matched_by and row.pub_matched_by != "" %}
        <div class="metadata-line"><strong>Opinion Matched by:</strong> {{ row.pub_matched_by}}</div>
    {% endif %}

    {% if row.index %}
        <div class="metadata-hide"><strong>Index:</strong> {{ row.index }}</div>
    {% endif %}
</details></div>

{% if row.warnings and row.warnings != "[]" and row.warnings != "" %}
<div class="error-notice">
    <strong>Warning:</strong> {{ row.warnings|replace('[', '')|replace(']', '')|replace('"', '') }}
</div>
{% endif %}

{% if row.formatting %}
    <script type="application/json" class="formatting-data" data-target="summary-{{ loop_index }}">{{ row.formatting }}</script>
{% endif %}
</div>

{% endmacro %}

</html>
